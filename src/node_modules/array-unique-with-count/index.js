module.exports = function uniqueWithCount(items) {
	if (!(
		items.every(item => Boolean(item.stats)) ||
		items.every(item => Boolean(item.stats.key))
	)) {
		throw TypeError('Every item should have a `stats` object with a `key` property')
	}

	return [
		...items.reduce((map, item) => {
			const existingItem = map.get(item.stats.key)
			return map.set(item.stats.key, {
				count: (existingItem && existingItem.count + 1) || 1,
				...item,
			})
		}, new Map()),
	].map(([key, item]) => {
		const { count, ...value } = item
		return { count, value }
	})
}